<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Opplæringsportal – Video + Quiz + Attest</title>

  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--acc:#22d3ee;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,var(--bg),#0b122a);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:20px;border-bottom:1px solid #263247;background:#0f172acc;backdrop-filter:blur(6px);position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:20px}
    .container{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
    .container.onecol{grid-template-columns:1fr}
    @media(max-width:1100px){.container{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--card),#0b1222);border:1px solid #263247;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .pad{padding:16px}
    label{display:block;font-size:12px;margin-top:10px;opacity:.95}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3a55;background:#0b1222;color:var(--text)}
    textarea{min-height:80px}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 14px;border-radius:12px;border:1px solid #263247;background:#1d2840;color:#dbeafe;cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--acc),#0ea5b7);border-color:transparent;color:#031f27;font-weight:600}
    .muted{font-size:12px;opacity:.75}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .bar{height:10px;background:#0b1222;border:1px solid #263247;border-radius:999px;overflow:hidden}
    .bar>div{height:100%;background:#22d3ee;width:0%}
    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}

    /* Attest-kort */
    #attest{background:white;color:#111;border-radius:12px}
    #cert { background:#ffffff; }
    #attest h2{margin:0 0 6px 0}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .imglogo{height:30px}

    /* Responsiv attest og grid */
    #attest { overflow:auto; }
    #attest .a4 {
      box-sizing: border-box;
      width: 100%;
      max-width: 210mm;      /* desktop */
      min-height: auto;      /* voks naturlig på mobil */
      padding: 16mm 14mm;
      background:#fff;
      color:#111;
      border-radius:12px;
    }
    @media (max-width: 768px){
      #attest .a4 { padding: 12mm 8mm; }
      .grid2 { grid-template-columns: 1fr; }
    }

    /* Signatur-canvas + mobiltegning */
    #sig{border:1px dashed #3a4c70;border-radius:8px;height:140px;background:#0b1222; touch-action:none;}
    html, body { overscroll-behavior: contain; width:100%; max-width:100%; overflow-x:hidden; }

    /* Admin vs learner */
    #adminPanel { display:none; }
    body.is-admin #adminPanel { display:block; }
    body.learner .admin-only { display:none !important; }

    /* Grid som ikke stikker utenfor */
    .container { grid-template-columns: minmax(0,380px) minmax(0,1fr); }
    .container.onecol { grid-template-columns: minmax(0,1fr); }
    @media(max-width:1100px){ .container { grid-template-columns: minmax(0,1fr); } }

    /* Video wrapper */
    #playerWrap { width:100%; max-width:100%; }
    #playerWrap iframe { width:100% !important; height:100% !important; }

    /* Små mobiler */
    @media(max-width:480px){ #sig { width:100%; height:180px; } }

    .note{font-size:12px;opacity:.85;padding:8px 10px;border:1px solid #2a3a55;border-radius:8px;background:#0b1222;margin-top:8px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #415983;background:#0c162a;font-size:11px}
    .hidden{display:none!important}
    .banner{margin:12px 16px 0;padding:10px 12px;border:1px dashed #3a4c70;border-radius:10px;background:#0b1222;font-size:12px}
    #btnSend{display:none!important} /* vi sender via mailto */

    /* Slå av effekter som kan gi blank PDF i Safari/iOS */
body.pdf-mode header { 
  backdrop-filter: none !important; 
  background:#0f172a !important; 
}
/* Skarp, mørk tekst i PDF */
#cert, #cert * { color:#000 !important; }
@media print {
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}

  </style>

  <!-- html2pdf (inkl. html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Sett body-klasse veldig tidlig for å unngå “flash” -->
  <script>
    (function(){
      const p = new URLSearchParams(location.search);
      const isAdmin = p.get('admin') === '1';
      document.addEventListener('DOMContentLoaded', function(){
        document.body.classList.add(isAdmin ? 'is-admin' : 'learner');
      });
    })();
  </script>
</head>

<body>
  <header>
    <h1>Opplæringsportal – Video + Quiz + Attest</h1>
    <div class="muted" id="subtitle">Se video → bestå quiz → bekreft & signer → generer attest (PDF) og logg</div>
  </header>

  <div id="topBanner" class="banner hidden"></div>

  <div class="container" id="layout">
    <!-- ADMIN -->
    <section id="adminPanel" class="card pad">
      <h2>Admin & kursbygger</h2>

      <details open>
        <summary><strong>Publisering (backend)</strong></summary>
        <label for="backendEndpoint">Backend-URL (Apps Script webapp /exec)</label>
        <input id="backendEndpoint" placeholder="https://script.google.com/macros/s/.../exec" />
        <label for="baseUrl">Offentlig base-URL til denne siden</label>
        <input id="baseUrl" />
        <div class="btnbar">
          <button id="btnPublish" class="primary">Publiser kurs → få CID</button>
          <button id="btnCopyLive">Kopier kurslenke</button>
          <span id="pubStatus" class="pill">Ikke publisert</span>
        </div>
        <p class="muted">Ved publisering lagres kurset i backend og får <em>cid</em>. Invitasjonslenker blir <code>?cid=…&uid=…&be=…</code>.</p>
      </details>

      <div style="height:1px;background:#263247;margin:12px 0"></div>

      <details open>
        <summary><strong>Kurs-bibliotek (lokalt)</strong></summary>
        <div class="row">
          <div>
            <label for="courseId">Velg lagret kurs</label>
            <select id="courseId"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="btnbar">
              <button id="btnLoad">Last</button>
              <button id="btnDelete">Slett</button>
            </div>
          </div>
        </div>
        <div class="btnbar">
          <button id="btnExportCourse">Eksporter kurs (JSON)</button>
          <button id="btnImportCourse">Importer kurs (JSON)</button>
        </div>
      </details>

      <div style="height:1px;background:#263247;margin:12px 0"></div>

      <details open>
        <summary><strong>Lag / rediger kurs</strong></summary>
        <label for="tool">Utstyr/verktøy</label>
        <select id="tool">
          <option value="personlofter">Personløfter – grunnleggende bruk</option>
          <option value="truck">Motvektstruck – sikker bruk</option>
          <option value="vinsj">Vinsj – sikker betjening</option>
          <option value="kappesliper">Kapp- og gjærsag – verneutstyr og bruk</option>
          <option value="custom">Egendefinert …</option>
        </select>
        <div id="customWrap" style="display:none">
          <label for="title">Egendefinert tittel</label>
          <input id="title" placeholder="F.eks. Borskrutrekker – modell X" />
        </div>

        <label for="yt">YouTube-URL (eller delingslenke)</label>
        <input id="yt" placeholder="https://www.youtube.com/watch?v=VIDEO_ID" />

        <div class="row">
          <div>
            <label for="threshold">Krav til sett prosent</label>
            <input id="threshold" type="number" min="0" max="100" value="90" />
          </div>
          <div>
            <label for="pass">Krav til riktig på quiz (%)</label>
            <input id="pass" type="number" min="0" max="100" value="80" />
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="logoUrl">Logo-URL (valgfri)</label>
            <input id="logoUrl" placeholder="https://…/logo.png" />
          </div>
        </div>

        <h3 style="margin-top:10px">Quiz-redigerer</h3>
        <div id="quizEditor"></div>
        <div class="btnbar">
          <button id="btnAddQ">+ Legg til spørsmål</button>
          <button id="btnAISuggest">AI: foreslå fra transkript</button>
        </div>
        <label for="transcript" class="muted">(Valgfritt) Lim inn transkript/innhold</label>
        <textarea id="transcript" placeholder="Lim inn transkript…"></textarea>
        <div class="btnbar">
          <button class="primary" id="btnSaveCourse">Lagre kurs (lokalt)</button>
          <button id="btnTest">Test video + quiz</button>
        </div>
      </details>

      <div style="height:1px;background:#263247;margin:12px 0"></div>

      <details>
        <summary><strong>Utsending</strong></summary>
        <label for="inviteList">Mottakere (kommaseparerte e-poster)</label>
        <textarea id="inviteList" placeholder="ola@example.no, kari@example.no"></textarea>
        <label for="inviteMsg">Melding til e-post</label>
        <textarea id="inviteMsg" placeholder="Hei! Du er tildelt kurs: … Klikk lenken for å starte."></textarea>
        <div class="btnbar">
          <button id="btnSend">Send invitasjoner via backend</button>
          <button id="btnMailto">Åpne e-postklient (fallback)</button>
        </div>
      </details>

      <div style="height:1px;background:#263247;margin:12px 0"></div>

      <h3>Deltaker (manuell test)</h3>
      <label for="empName">Navn</label>
      <input id="empName" />
      <div class="grid2">
        <div>
          <label for="empId">Ansattnr / ID</label>
          <input id="empId" />
        </div>
        <div>
          <label for="email">E-post</label>
          <input id="email" type="email" />
        </div>
      </div>
      <div class="btnbar"><button class="primary" id="btnLoadVideo">Last video</button></div>
      <p class="muted">Bruk YouTube (unlisted) eller erstatt med Vimeo/lokal fil senere.</p>
    </section>

    <!-- DELTAKER -->
    <section>
      <div class="card pad">
        <h3>Video</h3>
        <div id="playerWrap" style="aspect-ratio:16/9;background:#0b1222;border:1px solid #263247;border-radius:12px;display:grid;place-items:center;color:#89a3d1">
          <div>Velg/lagre kurs og trykk «Last video»</div>
        </div>
        <label style="margin-top:12px">Progresjon video</label>
        <div class="bar"><div id="pbar"></div></div>
        <div class="muted" id="ptext">0 % sett</div>
        <div class="note">Anti-juks: spoling fremover avvises og avspillingshastighet >1.25x låses.</div>
      </div>

      <div class="card pad" style="margin-top:12px">
        <h3>Quiz</h3>
        <div id="quiz"></div>
        <div class="btnbar">
          <button id="btnGrade">Sjekk svar</button>
          <span id="qres" class="muted"></span>
        </div>
      </div>

      <div class="card pad" style="margin-top:12px">
        <h3>Bekreftelse og signatur</h3>
        <label><input type="checkbox" id="ack" /> Jeg bekrefter at jeg har sett videoen og gjennomgått opplæringen.</label>
        <label for="sig">Signer i feltet under</label>
        <canvas id="sig" width="900" height="260"></canvas>
        <div class="btnbar">
          <button id="btnClearSig">Tøm signatur</button>
          <button class="primary" id="btnComplete" disabled>Bekreft opplæring og lag attest</button>
          <span class="muted" id="gateTxt">Lås opp: 1) se video ≥ krav, 2) bestå quiz ≥ krav, 3) kryss av og signer</span>
        </div>
      </div>

      <div id="attest" class="card pad" style="margin-top:12px;display:none">
        <div class="a4" id="cert">
          <div class="row" style="align-items:center">
      <div>
  <h2>Attest for gjennomført utstyrsspesifikk opplæring</h2>
  <div id="certSub" style="opacity:.8">Kurset er utført i regi av Garda Sikring AS.</div>
</div>

            <div style="text-align:right">
              <img class="imglogo" alt="Logo"
                   src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='50'%3E%3Crect width='200' height='50' rx='8' fill='%230ea5b7'/%3E%3Ctext x='100' y='32' fill='white' font-size='20' text-anchor='middle' font-family='Arial'%3EOPPL%C3%86RING%3C/text%3E%3C/svg%3E">
            </div>
          </div>
          <hr>
          <p><strong>Deltaker:</strong> <span id="c_name"></span> &nbsp; <strong>ID:</strong> <span id="c_id"></span> &nbsp; <strong>E-post:</strong> <span id="c_mail"></span></p>
          <p><strong>Kurs:</strong> <span id="c_course"></span> (<span id="c_cid"></span>)</p>
          <p><strong>Video:</strong> <span id="c_video"></span></p>
          <div class="grid2">
            <div>
              <p><strong>Video sett:</strong> <span id="c_seen"></span></p>
              <p><strong>Quiz resultat:</strong> <span id="c_quiz"></span></p>
              <p><strong>Dato/Tid (UTC):</strong> <span id="c_time"></span></p>
            </div>
            <div>
              <p><strong>Bekreftelse:</strong> Deltaker har bekreftet at opplæringen er gjennomført og forstått.</p>
              <p><strong>Henvisning:</strong> Forskrift om utførelse av arbeid kap. 10 (§§10-1, 10-2, 10-3, 10-4).</p>
            </div>
          </div>
          <div class="row" style="margin-top:16px">
            <div>
              <p><strong>Signatur deltaker:</strong></p>
              <img id="c_sig" alt="Signatur" style="max-width:100%;border:1px solid #ddd" />
            </div>
            <div>
              <p><strong>Signatur instruktør (valgfri):</strong></p>
              <div style="height:80px;border-bottom:1px solid #aaa"></div>
            </div>
          </div>
          <p style="margin-top:16px;font-size:12px;opacity:.8">Oppbevar dokumentasjonen iht. HMS-rutiner.</p>
        </div>

        <div class="btnbar" style="margin-top:10px">
          <button id="btnPrint" class="admin-only">Skriv ut / Lagre som PDF</button>
          <button id="btnPDF">Direkte PDF-eksport</button>
          <button id="btnCSV">Eksporter logg (CSV)</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Del 2/2 (JS) limes inn her, rett før </body> -->
  <script>
  // === Faste standardlenker ===
  const DEFAULT_BACKEND = 'https://script.google.com/macros/s/AKfycbzYlj2XoarcI9rbsKwRw1OVKpqr929WRSULmcr8O3czHGqt837uRClxn5yLR3sEtLzE/exec';
  const DEFAULT_BASE    = 'https://wbtomas-png.github.io/gardasikring/';

  // ---------- Hjelpere ----------
  const qs = s=>document.querySelector(s);
  const qsa = s=>Array.from(document.querySelectorAll(s));
  const escapeHtml = s=>(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const storageOK = ()=>{try{localStorage.setItem('_t','1');localStorage.removeItem('_t');return true;}catch(e){return false;}};
  const defaultBase = ()=> location.origin + location.pathname;
  const banner = (msg)=>{ const b=qs('#topBanner'); if(!b) return; b.textContent=msg; b.classList.remove('hidden'); };

  // ---------- Global status ----------
  let __cid = null;      // kurs-ID fra backend
  let __uid = null;      // valgfri bruker-ID fra URL
  let __backend = '';    // backend /exec

  function setPubStatus(txt){ const el=qs('#pubStatus'); if(el) el.textContent=txt; }
  function setBackend(url){ __backend = (url||'').trim(); const f=qs('#backendEndpoint'); if(f) f.value = __backend; }

  // ---------- Kurs-bibliotek (localStorage) ----------
  const getStore = ()=> storageOK()? JSON.parse(localStorage.getItem('courses')||'{}') : {};
  const setStore = obj=> { if(storageOK()){ localStorage.setItem('courses', JSON.stringify(obj)); fillCourseSelect(); } };
  function fillCourseSelect(){
    const sel=qs('#courseId'); if(!sel) return;
    const data=getStore(); sel.innerHTML='';
    Object.keys(data).forEach(id=>{
      const o=document.createElement('option');
      o.value=id; o.textContent=data[id].title||id; sel.appendChild(o);
    });
  }
  const newId = ()=> 'c_'+Math.random().toString(36).slice(2,10);

  function quizFromEditor(){
    const list=[];
    qsa('#quizEditor>div.qitem').forEach(qd=>{
      const q=qd.querySelector('.qtext').value;
      const a=[...qd.querySelectorAll('.opt')].map(o=>o.value);
      const radios=[...qd.querySelectorAll('input[type=radio]')];
      const c=radios.findIndex(r=>r.checked);
      list.push({q,a,c:Math.max(0,c)});
    });
    return list;
  }

  function buildQuizEditor(qsList){
    const wrap=qs('#quizEditor'); wrap.innerHTML='';
    const arr=(qsList&&qsList.length)?qsList:[{q:'',a:['',''],c:0}];
    arr.forEach(addQuestion);
  }
  function addQuestion(it){
    it=it||{q:'',a:['',''],c:0};
    const wrap=qs('#quizEditor');
    const div=document.createElement('div');
    div.className='qitem';
    div.style.cssText='border:1px solid #263247;border-radius:8px;padding:10px;margin-top:8px';
    div.innerHTML = `
      <label>Spørsmål</label>
      <input class="qtext" value="${escapeHtml(it.q)}" />
      <label>Svaralternativer (merk riktig)</label>
      <div class="opts"></div>
      <div class="btnbar">
        <button class="btnAddOpt">+ Alternativ</button>
        <button class="btnDelQ">Slett spørsmål</button>
      </div>`;
    wrap.appendChild(div);
    const opts=div.querySelector('.opts');
    const group='r'+Math.random().toString(36).slice(2,7);
    (it.a||['','']).forEach((opt,idx)=> addOpt(div, group, opt, idx===it.c));
    div.querySelector('.btnAddOpt').addEventListener('click', e=>{ e.preventDefault(); addOpt(div, group, '', false); });
    div.querySelector('.btnDelQ').addEventListener('click', e=>{ e.preventDefault(); div.remove(); });
  }
  function addOpt(qDiv, group, text='', correct=false){
    const opts=qDiv.querySelector('.opts');
    const row=document.createElement('div');
    row.style.cssText='display:grid;grid-template-columns:24px 1fr 80px;gap:8px;align-items:center;margin-top:6px';
    row.innerHTML=`<input type="radio" name="${group}" ${correct?'checked':''}>
                   <input class="opt" value="${escapeHtml(text)}" placeholder="Svaralternativ" />
                   <button class="btnRemOpt">Fjern</button>`;
    opts.appendChild(row);
    row.querySelector('.btnRemOpt').addEventListener('click', e=>{ e.preventDefault(); row.remove(); });
  }

  function courseFromUI(){
    return {
      tool: qs('#tool').value,
      title: qs('#tool').value==='custom' ? (qs('#title').value||'Egendefinert kurs') : qs('#tool option:checked').textContent,
      yt: qs('#yt').value.trim(),
      threshold: Number(qs('#threshold').value||90),
      pass: Number(qs('#pass').value||80),
      logo: (qs('#logoUrl')?.value || ''),
      quiz: quizFromEditor()
    };
  }
  function applyCourse(c){
    if(!c) return;
    qs('#tool').value = c.tool || 'custom';
    qs('#customWrap').style.display = (c.tool==='custom') ? 'block' : 'none';
    if(c.tool==='custom') qs('#title').value = c.title || '';
    qs('#yt').value = c.yt || '';
    qs('#threshold').value = c.threshold || 90;
    qs('#pass').value = c.pass || 80;
    if (qs('#logoUrl')) qs('#logoUrl').value = c.logo || '';
    buildQuizEditor(c.quiz || []);
  }

  function saveCourse(){
    const data=getStore(); const c=courseFromUI();
    let id=qs('#courseId').value||newId();
    data[id]=c; setStore(data);
    alert('Kurs lagret: '+(c.title||id));
  }
function loadCourse(){
  const id = qs('#courseId').value;
  const data = getStore();
  window.__loadedCourse = data[id];
  applyCourse(data[id]);
  buildQuizFromLoaded();

  __cid = id;          // bruk lokalt kurs-id som nøkkel
  loadParticipant();   // <— NY
  updateGate();        // <— NY
}

  function deleteCourse(){
    const id=qs('#courseId').value; if(!id) return;
    const data=getStore(); delete data[id]; setStore(data); alert('Slettet.');
  }
  function exportCourseJSON(){
    const id=qs('#courseId').value; const data=getStore();
    const c=data[id]||courseFromUI();
    const blob=new Blob([JSON.stringify(c,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=(c.title||'kurs')+'.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  function importCourseJSON(){
    const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
    inp.onchange=e=>{
      const f=e.target.files[0]; const r=new FileReader();
      r.onload=()=>{ try{ const c=JSON.parse(r.result); const data=getStore(); const id=newId(); data[id]=c; setStore(data); applyCourse(c); alert('Importert.'); }catch(err){ alert('Kunne ikke lese JSON.'); } };
      r.readAsText(f);
    };
    inp.click();
  }

  // ---------- Backend (Apps Script) ----------
  function backendURL(){
    const fromParam = (__backend && __backend.trim()) || '';
    const fromField = (qs('#backendEndpoint')?.value || '').trim();
    return fromParam || fromField || DEFAULT_BACKEND;
  }
  function baseURL(){
    const fromField = (qs('#baseUrl')?.value || '').trim();
    return fromField || DEFAULT_BASE || defaultBase();
  }

  async function publishCourse(){
    const url = backendURL(); if(!url){ alert('Sett backend-URL først.'); return; }
    const course = courseFromUI();
    try {
      const res = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ fn:'publish_course', course })
      });
      const data = await res.json();
      if (data.ok && data.cid) { __cid=data.cid; setPubStatus('Publisert: '+__cid); alert('Publisert. CID: '+__cid); return; }
    } catch(e) {}
    try {
      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(course))));
      const u = new URL(url);
      u.searchParams.set('fn','publish_course');
      u.searchParams.set('course', b64);
      const res2 = await fetch(u.toString());
      const data2 = await res2.json();
      if (data2.ok && data2.cid) { __cid=data2.cid; setPubStatus('Publisert: '+__cid); alert('Publisert. CID: '+__cid); return; }
      alert('Klarte ikke publisere (uventet svar).');
    } catch(err) {
      alert('Feil ved publisering. Sjekk backend-URL og at webappen er "Alle med lenken".');
    }
  }

function liveLinkFor(){
  if(!__cid) return null;
  const u = new URL(baseURL());
  u.searchParams.set('cid', __cid);
  const be = backendURL(); if (be) u.searchParams.set('be', be);
  return u.toString();
}

  function copyLiveLink(){
    if(!__cid){ alert('Kurs er ikke publisert ennå.'); return; }
    const url = liveLinkFor();
    navigator.clipboard.writeText(url).then(()=>alert('Lenke kopiert: '+url));
  }

  function mailtoFallback(){
    if(!__cid){ alert('Publiser kurs først (for å få https-lenke).'); return; }
    const emails=(qs('#inviteList').value||'').split(',').map(x=>x.trim()).filter(Boolean);
    if(!emails.length){ alert('Ingen mottakere.'); return; }
    const url = liveLinkFor();
    const subj = encodeURIComponent('Kurs: '+(courseFromUI().title||'opplæring'));
    const body = encodeURIComponent((qs('#inviteMsg').value || 'Hei! Klikk lenken for å starte:')+'\n\n'+url+'\n\n');
    window.location.href = 'mailto:'+emails.join(',')+'?subject='+subj+'&body='+body;
  }

  async function aiSuggestQuiz(){
    const url = backendURL(); const transcript = (qs('#transcript').value||'').trim();
    if(!transcript){ alert('Lim inn transkript først.'); return; }
    if(!url){ alert('Sett backend-URL først.'); return; }
    try{
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ fn:'quiz_from_transcript', transcript }) });
      const data = await res.json();
      if (Array.isArray(data.quiz)) { buildQuizEditor(data.quiz); alert('AI-forslag lagt inn.'); return; }
    }catch(e){}
    try{
      const b64 = btoa(unescape(encodeURIComponent(JSON.stringify({transcript}))));
      const u = new URL(url); u.searchParams.set('fn','quiz_from_transcript'); u.searchParams.set('transcript', b64);
      const res2 = await fetch(u.toString()); const data2 = await res2.json();
      if (Array.isArray(data2.quiz)) { buildQuizEditor(data2.quiz); alert('AI-forslag lagt inn.'); return; }
      alert('Endepunkt returnerte ikke forventet format.');
    }catch(err){ alert('Klarte ikke hente AI-forslag (nettverk/CORS).'); }
  }

  // ---------- Video/Quiz ----------
  let player, duration=0, seen=0, interval, threshold=0.9; let quizPct=0; let allowedAhead=3;
let __didUserGestureUnmute = false;
document.addEventListener('click', () => {
  if (!__didUserGestureUnmute && player && typeof player.unMute === 'function') {
    __didUserGestureUnmute = true;
    try { player.unMute(); player.setVolume(100); } catch(_) {}
  }
}, { once:true, capture:true });

  const DEFAULT_QUIZ = {
    personlofter:[
      {q:'Må du alltid gjøre funksjonstest før bruk?',a:['Ja','Nei'],c:0},
      {q:'Hva gjør du ved vind over maks grense?',a:['Kjører roligere','Stopper og tar ned liften'],c:1},
      {q:'Må du bruke sele ved kurv?',a:['Avhenger av type','Ja, ved fare for utkast'],c:1}
    ],
    truck:[
      {q:'Krever truck sertifisert opplæring (§10-3)?',a:['Nei','Ja'],c:1},
      {q:'Hva bestemmer maksimal last?',a:['Vekt og lastesenter','Dekktrykk'],c:0},
      {q:'Skal fotgjengerfelt respekteres?',a:['Ja','Nei'],c:0}
    ],
    vinsj:[
      {q:'Skal du stå i lastlinjen?',a:['Ja','Nei'],c:1},
      {q:'Hva gjør du ved uvanlig lyd?',a:['Ignorerer','Stopper og sjekker'],c:1},
      {q:'Trenger hansker?',a:['Anbefalt','Påkrevd ved ståltau'],c:1}
    ],
    kappesliper:[
      {q:'Skal vernedeksel være på?',a:['Valgfritt','Ja'],c:1},
      {q:'Briller og hørselvern?',a:['Ja','Nei'],c:0},
      {q:'Bytte blad mens plugget i?',a:['Ja','Nei'],c:1}
    ],
    custom:[
      {q:'Har du lest bruksanvisningen?',a:['Ja','Nei'],c:0},
      {q:'Er relevante farer forstått?',a:['Ja','Nei'],c:0},
      {q:'Kan du stopp/nødprosedyre?',a:['Ja','Nei'],c:0}
    ]
  };

  const getActiveQuiz = key=> (window.__loadedCourse&&Array.isArray(window.__loadedCourse.quiz)&&window.__loadedCourse.quiz.length)? window.__loadedCourse.quiz : (DEFAULT_QUIZ[key]||DEFAULT_QUIZ.custom);

  const ytId = url=>{ if(!url) return ''; const m=url.match(/[?&]v=([^&#]+)/)||url.match(/youtu\.be\/([^?&#]+)/); return m?m[1]:''; };

  function initVideo(){
    const sel=(window.__loadedCourse?.tool)||qs('#tool').value;
    qs('#customWrap').style.display = sel==='custom' ? 'block':'none';
    const url=(window.__loadedCourse?.yt)||qs('#yt').value.trim();
    const id=ytId(url);
    if(!id){ banner('Fant ikke YouTube-ID i lenken.'); return; }
    const w=qs('#playerWrap'); w.innerHTML='<div id="player"></div>';
    if(!window.YT){
      const tag=document.createElement('script'); tag.src='https://www.youtube.com/iframe_api'; document.body.appendChild(tag);
      window.onYouTubeIframeAPIReady=()=>createPlayer(id);
    } else { createPlayer(id); }
    buildQuizFromLoaded(); updateGate();
  }
function createPlayer(id){
  player = new YT.Player('player', {
    videoId: id,
    playerVars: {
      rel: 0,
      modestbranding: 1,
      controls: 1,
      disablekb: 0,
      playsinline: 1   // iOS: spill i siden
    },
    events: {
      onReady: (e) => {
        // Sørg for lyd
        try { e.target.unMute(); e.target.setVolume(100); } catch(_) {}
        duration = e.target.getDuration();
        startTrack();
        tryLockRate();
      },
      onStateChange: onPlayerStateChange,
      
      onPlaybackRateChange: tryLockRate
    }
  });
}

function onPlayerStateChange(e){
  // Når bruker starter (playing), pass på at den ikke er mutet
  if (e.data === YT.PlayerState.PLAYING) {
    try { e.target.unMute(); e.target.setVolume(100); } catch(_) {}
    startTrack();
  }
}
function tryLockRate(){
  if (!player || !player.getPlaybackRate) return;
  const r = player.getPlaybackRate();
  if (r > 1.25) { try { player.setPlaybackRate(1); } catch(e){} }
}

function startTrack(){
  clearInterval(interval);
  threshold = (Number((window.__loadedCourse?.threshold) || qs('#threshold').value || 90) / 100);
  allowedAhead = 3;
  let lastTime = 0;

  interval = setInterval(()=>{
    if (!player || typeof player.getCurrentTime !== 'function') return;

    const cur = player.getCurrentTime();
    duration = Math.max(duration, player.getDuration());

    // Anti-spoling framover / bakover-hopp
    if (cur > seen + allowedAhead) { player.seekTo(seen + 0.5, true); return; }
    if (cur < lastTime - 1)       { player.seekTo(lastTime, true);   return; }

    seen = Math.max(seen, cur);
    lastTime = cur;
    tryLockRate();

    const pct = duration ? Math.min(100, (seen/duration)*100) : 0;
    qs('#pbar').style.width = pct.toFixed(1) + '%';
    qs('#ptext').textContent = pct.toFixed(1) + ' % sett';
    updateGate();
  }, 500);
}


  function buildQuizFromLoaded(){
    const k=(window.__loadedCourse?.tool)||qs('#tool').value;
    const q=getActiveQuiz(k);
    const wrap=qs('#quiz'); wrap.innerHTML='';
    q.forEach((it,i)=>{
      const div=document.createElement('div'); div.style.marginBottom='10px';
      div.innerHTML=`<div>${i+1}. ${escapeHtml(it.q)}</div>`+
        it.a.map((opt,j)=>`<label style="display:block;margin-left:8px"><input type="radio" name="q${i}" value="${j}"> ${escapeHtml(opt)}</label>`).join('');
      wrap.appendChild(div);
    });
    qs('#qres').textContent='';
  }

  function gradeQuiz(){
    const qsArr=getActiveQuiz((window.__loadedCourse?.tool)||qs('#tool').value);
    let ok=0; qsArr.forEach((it,i)=>{ const v=document.querySelector(`input[name=q${i}]:checked`); if(v && Number(v.value)===it.c) ok++; });
    quizPct=qsArr.length?Math.round((ok/qsArr.length)*100):100;
    qs('#qres').textContent=`Score: ${ok}/${qsArr.length} (${quizPct}%)`;
    updateGate();
  }

  // ---------- Signatur ----------
  const sig = document.getElementById('sig');
  const ctx = sig.getContext('2d');
  let drawing = false, lastPt = null;

  function canvasPoint(e){
    const r = sig.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return [ touch.clientX - r.left, touch.clientY - r.top ];
  }
  function startDraw(e){
    drawing = true; lastPt = canvasPoint(e);
    document.body.style.overflow = 'hidden';
  }
  function moveDraw(e){
    if(!drawing) return;
    e.preventDefault();
    const p = canvasPoint(e);
    ctx.strokeStyle = '#9fc3ff';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(lastPt[0], lastPt[1]);
    ctx.lineTo(p[0], p[1]);
    ctx.stroke();
    lastPt = p;
  }
  function endDraw(){
    drawing = false;
    document.body.style.overflow = '';
    updateGate();
  }
  sig.addEventListener('pointerdown', startDraw);
  sig.addEventListener('pointermove', moveDraw, { passive:false });
  ['pointerup','pointerleave','pointercancel'].forEach(ev => sig.addEventListener(ev, endDraw));

  function clearSig(){ ctx.clearRect(0,0,sig.width,sig.height); updateGate(); }
  function isCanvasBlank(c){ const p=c.getContext('2d').getImageData(0,0,c.width,c.height).data; for(let i=3;i<p.length;i+=4){ if(p[i]!==0) return false; } return true; }

function participantOk(){
  const name = (qs('#empName')?.value || '').trim();
  const id   = (qs('#empId')?.value   || '').trim();
  const mail = (qs('#email')?.value   || '').trim();
  // Minstekrav: navn + (ID eller e-post)
  return !!(name && (id || mail));
}

    // --- Autolagring av deltakerfelt per kurs (localStorage) ---
const PARTICIPANT_KEY = () => `participant:${__cid || 'local'}`;

function saveParticipant(){
  if (!storageOK()) return;
  const data = {
    name: (qs('#empName')?.value || '').trim(),
    id:   (qs('#empId')?.value   || '').trim(),
    mail: (qs('#email')?.value   || '').trim()
  };
  try { localStorage.setItem(PARTICIPANT_KEY(), JSON.stringify(data)); } catch(_) {}
}

function loadParticipant(){
  if (!storageOK()) return;
  try {
    const raw = localStorage.getItem(PARTICIPANT_KEY());
    if (!raw) return;
    const { name, id, mail } = JSON.parse(raw) || {};
    if (name) qs('#empName').value = name;
    if (id)   qs('#empId').value   = id;
    if (mail) qs('#email').value   = mail;
  } catch(_) {}
}

    
  // ---------- Gate & fullfør ----------
function updateGate(){
  const need   = Number((window.__loadedCourse?.pass)      || qs('#pass').value || 80);
  const tNeed  = Number((window.__loadedCourse?.threshold) || qs('#threshold').value || 90);
  const pct    = duration ? Math.min(100, (seen/duration)*100) : 0;

  const okVideo = pct >= tNeed;
  const okQuiz  = quizPct >= need;
  const okAck   = qs('#ack').checked;
  const hasSig  = !isCanvasBlank(sig);
  const okWho   = participantOk();

  const open = okVideo && okQuiz && okAck && hasSig && okWho;
  qs('#btnComplete').disabled = !open;

  qs('#gateTxt').innerHTML =
    `Video: <span class="${okVideo?'ok':'err'}">${okVideo? 'klart':'mangler ('+pct.toFixed(0)+'%/'+tNeed+'%)'}</span> · `+
    `Quiz: <span class="${okQuiz?'ok':'err'}">${okQuiz? 'klart':'mangler ('+quizPct+'%/'+need+'%)'}</span> · `+
    `Bekreftelse: <span class="${okAck?'ok':'err'}">${okAck? 'krysset':'mangler'}</span> · `+
    `Signatur: <span class="${hasSig?'ok':'err'}">${hasSig? 'ok':'mangler'}</span> · `+
    `Deltakerinfo: <span class="${okWho?'ok':'err'}">${okWho? 'ok':'mangler (navn + ID/epost)'}</span>`;
}


  async function completeAndGenerate(){
    const btn=qs('#btnComplete'); if(btn.disabled){ alert('Oppfyll kravene først.'); return; }

    const name=(qs('#empName').value||'').trim();
    const id=(qs('#empId').value||'').trim();
    const mail=(qs('#email').value||'').trim();
    const c = window.__loadedCourse || courseFromUI();
    const url=(qs('#yt').value||c.yt||'').trim();
    const pct=duration?Math.min(100,(seen/duration)*100):0;
    const now=new Date().toISOString();

    // fyll attest
    qs('#c_name').textContent=name;
    qs('#c_id').textContent=id;
    qs('#c_mail').textContent=mail;
    qs('#c_course').textContent=c.title||'';
    qs('#c_cid').textContent=__cid||'(lokal)';
    qs('#c_video').textContent=url;
    qs('#c_seen').textContent=pct.toFixed(1)+' %';
    qs('#c_quiz').textContent=quizPct+' %';
    qs('#c_time').textContent=now;
    try{ qs('#c_sig').src = sig.toDataURL('image/png'); }catch(_){}
    const logoUrl = (window.__loadedCourse?.logo) || (qs('#logoUrl')?.value) || '';
    if (logoUrl){
      const img = qs('#cert').querySelector('img.imglogo');
      if (img) { img.src = logoUrl; img.alt = 'Logo'; }
    }
    qs('#attest').style.display = 'block';
    qs('#attest').scrollIntoView({ behavior:'smooth', block:'start' });

    // lokal logg
    if(storageOK()){
      const arr=JSON.parse(localStorage.getItem('trainingLog')||'[]');
      arr.push({cid:__cid||'',uid:__uid||'',name,id,mail,course:c.title||'',url,seen:pct.toFixed(1),quiz:quizPct,time:now});
      localStorage.setItem('trainingLog', JSON.stringify(arr));
    }

    // backend logg
    const endpoint = backendURL();
    if (endpoint && __cid) {
      const rec = { cid:__cid, uid:__uid||'', name, id, mail, course:c.title||'', url, seen:pct.toFixed(1), quiz:quizPct, time:now };
      try {
        await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fn:'log_completion', rec})});
      } catch(e) {
        try {
          const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(rec))));
          const u = new URL(endpoint); u.searchParams.set('fn','log_completion'); u.searchParams.set('rec', b64);
          await fetch(u.toString());
        }catch(_){}
      }
    }

    alert('Attest generert. Du kan nå skrive ut eller lagre PDF.');
  }

  // ---------- PDF-eksport (stabil pipeline via html2pdf) ----------
  async function ensureInlineImages(root){
    const imgs = root.querySelectorAll('img');
    await Promise.all([...imgs].map(async img => {
      const src = img.getAttribute('src') || '';
      if (!src || src.startsWith('data:')) return;
      try{
        const resp = await fetch(src, { mode: 'cors' });
        if (!resp.ok) throw new Error('img fetch failed');
        const blob = await resp.blob();
        const dataUrl = await new Promise((res, rej)=>{
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(blob);
        });
        img.setAttribute('src', dataUrl);
      }catch(e){
        console.warn('Kunne ikke inline-bilde for PDF:', src, e);
      }
    }));
  }

// Hjelper for iOS (senker scale for å unngå blank PDF)
function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent)
      || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}

async function exportPDFCert(){
  const cert = document.querySelector('#cert');
  const wrap = document.querySelector('#attest');

  if (!cert) { alert('Fant ikke attest-innhold (#cert).'); return; }

  // Vis attesten hvis den er skjult (html2canvas blir blank ellers)
  if (getComputedStyle(wrap).display === 'none') {
    wrap.style.display = 'block';
    await new Promise(r => requestAnimationFrame(r));
  }

  // Inline bilder (logo + signatur) for å unngå CORS → blank PDF
  await ensureInlineImages(cert).catch(()=>{});

  // Slå av problematiske effekter kun under render
  document.body.classList.add('pdf-mode');

  const name   = (document.querySelector('#c_name').textContent   || 'attest').replace(/\s+/g,'_');
  const course = (document.querySelector('#c_course').textContent || 'kurs').replace(/\s+/g,'_');
  const dt     = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');

  try{
await html2pdf()
  .from(cert)
  .set({
    margin: 10,
    filename: `${name}_${course}_${dt}.pdf`,
    // ① PNG bevarer skarp tekst
    image: { type:'png', quality:1 },

    // ② Høyere scale gir skarpere resultat (men lavere på iOS for stabilitet)
    html2canvas: {
      scale: isIOS() ? 1.5 : 3,
      useCORS: true,
      backgroundColor: '#ffffff',
      logging: false,
      letterRendering: true,   // ③ gir litt fyldigere glyphs
      scrollY: 0
    },

    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  })
  .save();

  } finally {
    document.body.classList.remove('pdf-mode');
  }
}







  function exportCSV(){
    const arr = storageOK() ? JSON.parse(localStorage.getItem('trainingLog')||'[]') : [];
    if(!arr.length){ alert('Ingen logger ennå.'); return; }
    const cols = ['cid','uid','name','id','mail','course','url','seen','quiz','time'];
    const csv = [cols.join(';')]
      .concat(arr.map(o => cols.map(k => `"${(o[k]||'').toString().replace(/"/g,'""')}"`).join(';')))
      .join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'opplaering_logg.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---------- URL-param + learner-modus ----------
  function enterLearnerMode(course){
    const admin = qs('#adminPanel'); if (admin) admin.classList.add('hidden');
    const cont = qs('#layout'); if (cont) cont.classList.add('onecol');
    const hdr = qs('#subtitle'); if (hdr && course){ hdr.textContent = 'Kurs: ' + (course.title||''); }
    document.body.classList.add('learner');
  }

  async function loadFromURL(){
    const p=new URLSearchParams(location.search);
    const cid=p.get('cid'); __uid=p.get('uid'); const be=p.get('be');
    if(be){ try{ setBackend(decodeURIComponent(be)); }catch(e){ setBackend(be); } }

    // sett standarder + lås felt
    setBackend(DEFAULT_BACKEND);
    if (qs('#baseUrl')) qs('#baseUrl').value = DEFAULT_BASE;
    if (qs('#backendEndpoint')) { qs('#backendEndpoint').value = DEFAULT_BACKEND; qs('#backendEndpoint').readOnly = true; }
    if (qs('#baseUrl')) { qs('#baseUrl').readOnly = true; }

    const adminFlag = p.get('admin');

    if(cid){
      const url=backendURL(); if(!url){ banner('Mangler backend-URL. Lenken bør inneholde &be=…'); return; }
      try{
        const res=await fetch(url+'?cid='+encodeURIComponent(cid));
        const data=await res.json();
        if(data && data.course){
          window.__loadedCourse=data.course; applyCourse(data.course); buildQuizFromLoaded();
          __cid=cid; setPubStatus('Fra lenke: '+__cid);

  loadParticipant();   // ← NY linje
  updateGate();        // ← NY linje
          
          if(!adminFlag) enterLearnerMode(data.course);
          initVideo();
        } else banner('Fant ikke kurs for angitt cid.');
      }catch(e){ banner('Klarte ikke hente kurs fra backend. Sjekk at /exec er riktig.'); }
    }
  }


// ---------- Events ----------
document.addEventListener('DOMContentLoaded', () => {
  // Init grunnleggende UI
  qs('#baseUrl').value = defaultBase();
  fillCourseSelect();
  buildQuizEditor();
  loadFromURL();

  // Lytt på deltakerfeltene: oppdatér portvakt + autolagre
  const handleParticipantInput = () => { updateGate(); saveParticipant(); };
  ['#empName', '#empId', '#email'].forEach(sel => {
    const el = qs(sel);
    if (el) el.addEventListener('input', handleParticipantInput);
  });

  // admin
  qs('#tool').addEventListener('change', () => {
    qs('#customWrap').style.display = qs('#tool').value === 'custom' ? 'block' : 'none';
  });
  qs('#btnLoad').addEventListener('click',  e => { e.preventDefault(); loadCourse(); });
  qs('#btnDelete').addEventListener('click',e => { e.preventDefault(); deleteCourse(); });
  qs('#btnExportCourse').addEventListener('click', e => { e.preventDefault(); exportCourseJSON(); });
  qs('#btnImportCourse').addEventListener('click', e => { e.preventDefault(); importCourseJSON(); });
  qs('#btnAddQ').addEventListener('click', e => { e.preventDefault(); addQuestion(); });
  qs('#btnAISuggest').addEventListener('click', e => { e.preventDefault(); aiSuggestQuiz(); });
  qs('#btnSaveCourse').addEventListener('click', e => { e.preventDefault(); saveCourse(); });
  qs('#btnTest').addEventListener('click', e => { e.preventDefault(); initVideo(); });

  // publisering/lenker
  qs('#btnPublish').addEventListener('click', e => { e.preventDefault(); publishCourse(); });
  qs('#btnCopyLive').addEventListener('click', e => { e.preventDefault(); copyLiveLink(); });

  // utsending (kun mailto)
  qs('#btnMailto').addEventListener('click', e => { e.preventDefault(); mailtoFallback(); });

  // deltaker
  qs('#btnLoadVideo').addEventListener('click', e => { e.preventDefault(); initVideo(); });
  qs('#btnGrade').addEventListener('click', e => { e.preventDefault(); gradeQuiz(); });
  qs('#ack').addEventListener('change', updateGate);
  qs('#btnClearSig').addEventListener('click', e => { e.preventDefault(); clearSig(); });
  qs('#btnComplete').addEventListener('click', e => { e.preventDefault(); completeAndGenerate(); });

  // attest
  qs('#btnPrint').addEventListener('click', e => { e.preventDefault(); window.print(); });
  qs('#btnPDF').addEventListener('click', e => { e.preventDefault(); exportPDFCert(); });
  qs('#btnCSV').addEventListener('click', e => { e.preventDefault(); exportCSV(); });

  // initial portvakt-status på første last
  updateGate();
});

  </script>
</body>
</html>










